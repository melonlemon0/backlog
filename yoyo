<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BackLog ‚Äì Know your pain</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg-main: #fdfaf5;
      --bg-card: #ffffff;
      --border-soft: #e2e2e2;
      --text-main: #111111;
      --text-muted: #888888;
      --accent: #ffd86b;
      --accent-soft: #fff3c2;
      --red: #ff4b4b;
      --yellow: #ffd86b;
      --green: #4caf50;
      --shadow-soft: 0 8px 20px rgba(0, 0, 0, 0.05);
      --radius-card: 16px;
      --radius-pill: 999px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Helvetica Neue", Arial, sans-serif;
      background: #e5e5ea;
      color: var(--text-main);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 24px 8px;
    }

    .phone-frame {
      width: 100%;
      max-width: 420px;
      height: min(800px, 92vh);
      background: linear-gradient(145deg, #fefcf8, #f9f2e8);
      border-radius: 40px;
      padding: 16px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.25);
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .inner-screen {
      width: 100%;
      height: 100%;
      background: var(--bg-main);
      border-radius: 28px;
      padding: 12px 12px 16px;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
    }

    .dynamic-island {
      width: 110px;
      height: 28px;
      background: #000;
      border-radius: 999px;
      margin: 0 auto 8px;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 6px 12px;
    }

    .title {
      font-weight: 700;
      font-size: 18px;
    }

    .subtitle {
      font-size: 12px;
      color: var(--text-muted);
    }

    .code-tag {
      margin-top: 3px;
      font-size: 10px;
      color: #a18c64;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px dashed #decba0;
      display: inline-block;
      cursor: pointer;
    }

    .top-right {
      display: flex;
      gap: 8px;
      align-items: center;
      font-size: 11px;
      color: var(--text-muted);
    }

    .battery {
      width: 22px;
      height: 11px;
      border-radius: 4px;
      border: 1px solid var(--text-muted);
      position: relative;
    }

    .battery::after {
      content: "";
      position: absolute;
      right: -3px;
      top: 2px;
      width: 2px;
      height: 7px;
      border-radius: 2px;
      background: var(--text-muted);
    }

    .battery-fill {
      position: absolute;
      inset: 2px;
      border-radius: 2px;
      background: var(--green);
    }

    .tabs {
      background: #f1e7d7;
      border-radius: var(--radius-pill);
      padding: 4px;
      display: flex;
      gap: 4px;
      margin-bottom: 10px;
    }

    .tab {
      flex: 1;
      text-align: center;
      font-size: 13px;
      padding: 6px 0;
      border-radius: var(--radius-pill);
      cursor: pointer;
      user-select: none;
      transition: background 0.2s, color 0.2s, transform 0.1s;
      color: #7f6b4a;
    }

    .tab.active {
      background: #fff7e4;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);
      color: #4a3a22;
      font-weight: 600;
      transform: translateY(-1px);
    }

    .content {
      flex: 1;
      overflow-y: auto;
      padding: 4px 2px 0;
      scrollbar-width: thin;
      scrollbar-color: #d4c6aa transparent;
    }

    .content::-webkit-scrollbar { width: 4px; }
    .content::-webkit-scrollbar-thumb {
      background: #d4c6aa;
      border-radius: 999px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 4px 4px 8px;
      gap: 8px;
    }

    .section-title {
      font-size: 15px;
      font-weight: 600;
      color: #4a3a22;
    }

    .section-subtitle {
      font-size: 11px;
      color: var(--text-muted);
    }

    .header-actions {
      display: flex;
      gap: 4px;
      align-items: center;
    }

    .btn-primary {
      background: #f1c24b;
      border-radius: var(--radius-pill);
      border: none;
      padding: 6px 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 32px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    }

    .btn-primary:active {
      transform: translateY(1px);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.18);
    }

    .btn-ghost {
      background: transparent;
      border-radius: var(--radius-pill);
      border: 1px solid #e4d3b5;
      padding: 5px 10px;
      font-size: 11px;
      cursor: pointer;
    }

    .btn-icon {
      width: 32px;
      height: 28px;
      border-radius: 999px;
      border: 1px solid #ddd0b7;
      background: #faf3e1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 0.08em;
      color: #6b5a38;
      cursor: pointer;
    }

    .btn-icon:active {
      transform: translateY(1px);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);
    }

    .btn-small {
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid #e4d3b5;
      background: transparent;
      cursor: pointer;
    }

    .btn-small-danger {
      border-color: #e8dede;
      color: #9b6666;
      opacity: 0.8;
      display: inline-flex;
      align-items: center;
      gap: 3px;
    }

    .card {
      background: var(--bg-card);
      border-radius: var(--radius-card);
      padding: 10px 12px;
      margin-bottom: 8px;
      box-shadow: var(--shadow-soft);
      border: 1px solid #f0e3cd;
      cursor: pointer;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .card-date {
      font-size: 12px;
      font-weight: 600;
      color: #6a5735;
    }

    .card-time {
      font-size: 11px;
      color: var(--text-muted);
    }

    .card-row {
      font-size: 12px;
      margin-top: 3px;
      color: #3b3121;
    }

    .label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    .field-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #b3a48b;
      display: block;
      margin-bottom: 1px;
    }

    .field-text {
      font-size: 12px;
      color: #3b3121;
      white-space: pre-wrap;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 8px;
      border-radius: var(--radius-pill);
      font-size: 11px;
      font-weight: 600;
      color: #fff;
      min-width: 58px;
    }

    .pill-bad { background: var(--red); }
    .pill-meh { background: #f2b400; }
    .pill-good { background: var(--green); }
    .pill-muted { background: #ccc; color: #333; }

    .calendar-wrapper {
      background: var(--bg-card);
      border-radius: var(--radius-card);
      padding: 10px 10px 8px;
      box-shadow: var(--shadow-soft);
      border: 1px solid #f0e3cd;
      margin-bottom: 10px;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .calendar-month {
      font-size: 14px;
      font-weight: 600;
      color: #4a3a22;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      font-size: 11px;
      text-align: center;
    }

    .calendar-day-label {
      font-size: 10px;
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    .calendar-cell {
      height: 28px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      position: relative;
      transition: transform 0.05s, box-shadow 0.1s, background 0.1s, color 0.1s;
      background: #f4ead8;
      color: #4a3a22;
    }

    .calendar-cell.empty {
      background: transparent;
      cursor: default;
    }

    .calendar-cell.selected {
      box-shadow: 0 0 0 1px #4a3a22;
    }

    .calendar-cell.bad {
      background: var(--red);
      color: #ffffff;
    }

    .calendar-cell.meh {
      background: var(--yellow);
      color: #4a3a22;
    }

    .calendar-cell.good {
      background: var(--green);
      color: #ffffff;
    }

    .calendar-legend {
      display: flex;
      gap: 6px;
      justify-content: flex-end;
      margin-top: 6px;
      font-size: 10px;
      color: var(--text-muted);
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .legend-color {
      width: 10px;
      height: 10px;
      border-radius: 999px;
    }

    .day-details-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .day-details-empty {
      font-size: 11px;
      color: var(--text-muted);
      padding: 4px 2px;
    }

    #summary-section {
      margin: 12px 4px 4px;
    }

    .summary-card {
      background: var(--bg-card);
      border-radius: var(--radius-card);
      padding: 8px 10px;
      margin-bottom: 6px;
      border: 1px solid #f0e3cd;
      box-shadow: var(--shadow-soft);
      font-size: 12px;
    }

    .summary-title-line {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
      font-weight: 600;
      color: #4a3a22;
    }

    .summary-sub {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    .summary-row {
      font-size: 11px;
      margin-top: 2px;
    }

    .ideas-wrapper { margin-top: 4px; }

    .idea-form,
    .idea-card {
      background: var(--bg-card);
      padding: 10px 10px 8px;
      border-radius: var(--radius-card);
      border: 1px solid #f0e3cd;
      box-shadow: var(--shadow-soft);
      margin-bottom: 10px;
    }

    .idea-card {
      cursor: pointer;
    }

    .idea-card:hover {
      box-shadow: 0 10px 22px rgba(0,0,0,0.07);
    }

    .idea-form-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 8px;
    }

    .idea-input,
    .idea-textarea,
    .entry-input,
    .entry-textarea {
      width: 100%;
      border-radius: 12px;
      border: 1px solid #e0d3bc;
      padding: 7px 9px;
      font-size: 12px;
      background: #fffdf6;
      outline: none;
      resize: vertical;
      min-height: 28px;
    }

    .idea-textarea,
    .entry-textarea { min-height: 60px; }

    .idea-input:focus,
    .idea-textarea:focus,
    .entry-input:focus,
    .entry-textarea:focus {
      border-color: #e3b340;
      box-shadow: 0 0 0 1px #ffe09a;
      background: #fffef8;
    }

    .idea-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
      color: #3e311d;
    }

    .idea-body {
      font-size: 12px;
      color: #4c3d25;
      margin-bottom: 4px;
      white-space: pre-wrap;
    }

    .idea-meta {
      font-size: 10px;
      color: var(--text-muted);
    }

    .idea-form-actions {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .bottom-safe { height: 12px; }

    .entry-sheet-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.15);
      display: none;
      align-items: flex-end;
      justify-content: center;
      z-index: 20;
    }

    .entry-sheet-backdrop.active { display: flex; }

    .entry-sheet {
      width: 100%;
      max-width: 420px;
      background: var(--bg-main);
      border-radius: 24px 24px 0 0;
      padding: 10px 14px 14px;
      box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.25);
      border-top: 1px solid #e4d6bf;
      max-height: 80%;
      overflow-y: auto;
    }

    .entry-sheet-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .entry-sheet-title {
      font-size: 15px;
      font-weight: 600;
    }

    .entry-sheet-actions {
      display: flex;
      gap: 6px;
    }

    .entry-form-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin: 6px 0;
    }

    .pain-options {
      display: flex;
      gap: 6px;
      margin-top: 2px;
    }

    .pain-option {
      flex: 1;
      text-align: center;
      padding: 6px 0;
      border-radius: var(--radius-pill);
      font-size: 12px;
      cursor: pointer;
      border: 1px solid transparent;
      user-select: none;
    }

    .pain-option[data-pain="bad"] {
      background: #ffe3e3;
      border-color: #ffc2c2;
      color: #b02222;
    }

    .pain-option[data-pain="meh"] {
      background: #fff3cf;
      border-color: #ffe3a6;
      color: #8a6300;
    }

    .pain-option[data-pain="good"] {
      background: #ddf7de;
      border-color: #bde8c0;
      color: #216527;
    }

    .pain-option.active {
      box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.1);
      font-weight: 600;
    }

    .empty-state {
      font-size: 12px;
      color: var(--text-muted);
      padding: 8px 6px;
      border-radius: 12px;
      border: 1px dashed #e3d3b8;
      background: #fdf6e9;
      text-align: center;
    }

    /* Intro overlay */

    .intro-overlay {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, #fffaf0, #e2d5c0);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 100;
    }

    .intro-card {
      max-width: 420px;
      width: 100%;
      background: #fffdf6;
      border-radius: 24px;
      padding: 20px 18px 18px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.2);
      border: 1px solid #f0e3cd;
    }

    .intro-title {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 4px;
      color: #3c2f1b;
    }

    .intro-subtitle {
      font-size: 13px;
      color: #7a6a4c;
      margin-bottom: 10px;
    }

    .intro-bullets {
      font-size: 12px;
      color: #55442a;
      margin-bottom: 12px;
    }

    .intro-bullets li {
      margin-left: 18px;
      margin-bottom: 4px;
    }

    .intro-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #a18c64;
      margin-bottom: 4px;
    }

    .code-input {
      width: 100%;
      border-radius: 14px;
      border: 1px solid #e0d3bc;
      padding: 8px 10px;
      font-size: 14px;
      background: #fffef8;
      outline: none;
      text-align: center;
      letter-spacing: 0.18em;
      text-transform: uppercase;
    }

    .code-input:focus {
      border-color: #e3b340;
      box-shadow: 0 0 0 1px #ffe09a;
    }

    .code-hint {
      font-size: 11px;
      color: #a18c64;
      margin-top: 4px;
      margin-bottom: 10px;
    }

    .code-error {
      font-size: 11px;
      color: #c03b3b;
      min-height: 14px;
      margin-bottom: 8px;
    }

    .intro-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .intro-small {
      font-size: 10px;
      color: #9c8c6d;
    }

    @media (max-width: 480px) {
      body {
        padding: 12px 4px;
      }

      .phone-frame {
        height: 92vh;
        border-radius: 32px;
        padding: 12px;
      }

      .inner-screen { border-radius: 24px; }

      .intro-card {
        border-radius: 20px;
        padding: 16px 14px 14px;
      }
    }

    @media print {
      body {
        background: #fff;
        padding: 0;
        align-items: flex-start;
      }
      .phone-frame {
        box-shadow: none;
        border-radius: 0;
        height: auto;
        padding: 0;
        border: none;
      }
      .inner-screen {
        border-radius: 0;
        padding: 16px;
        height: auto;
      }
      .dynamic-island,
      .tabs,
      .no-print,
      .intro-overlay {
        display: none !important;
      }
      .content {
        overflow: visible;
      }
    }
  </style>
</head>
<body>
  <!-- Intro / Passcode overlay -->
  <div id="intro-overlay" class="intro-overlay">
    <div class="intro-card">
      <div class="intro-title">BackLog</div>
      <div class="intro-subtitle">
        A tiny notebook for your back pain ‚Äî see patterns, not just bad days.
      </div>
      <ul class="intro-bullets">
        <li>Log symptoms, treatments, and feelings in seconds.</li>
        <li>See pain colors on a calendar and weekly trends.</li>
        <li>Share a simple access code with your doctor or friends.</li>
      </ul>

      <div class="intro-label">Access code</div>
      <input
        id="code-input"
        class="code-input"
        maxlength="7"
        placeholder="1234ABC"
      />
      <div class="code-hint">
        4 numbers + 3 letters (e.g. 2025BPK). Anyone with this code can see this space
        <span style="font-style:italic;">on this device</span>.
      </div>
      <div id="code-error" class="code-error"></div>

      <div class="intro-footer">
        <div class="intro-small">
          No sign up, no email. Just remember your code.
        </div>
        <button id="btn-enter-app" class="btn-primary">Enter</button>
      </div>
    </div>
  </div>

  <div class="phone-frame">
    <div class="inner-screen">
      <div class="dynamic-island no-print"></div>

      <div class="top-bar no-print">
        <div>
          <div class="title">BackLog</div>
          <div class="subtitle">Know your pain</div>
          <div id="code-tag" class="code-tag" style="display:none;">
            Code: ----
          </div>
        </div>
        <div class="top-right">
          <span id="fake-time">9:41</span>
          <div class="battery">
            <div class="battery-fill"></div>
          </div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tabs no-print">
        <div class="tab active" data-tab="entries">Entries</div>
        <div class="tab" data-tab="calendar">Calendar</div>
        <div class="tab" data-tab="ideas">Ideas</div>
      </div>

      <!-- Content -->
      <div class="content">
        <!-- Entries Tab -->
        <div id="tab-entries" class="tab-panel">
          <div class="section-header">
            <div>
              <div class="section-title">All Entries</div>
              <div class="section-subtitle">Daily logs in BackLog</div>
            </div>
            <div class="header-actions no-print">
              <button id="btn-export" class="btn-icon" title="Export as text file">TXT</button>
              <button id="btn-print" class="btn-icon" title="Print / Save as PDF">PDF</button>
              <button id="btn-add-entry" class="btn-primary">Ôºã</button>
            </div>
          </div>
          <div id="entries-list"></div>

          <!-- Summary Section -->
          <div id="summary-section">
            <div class="section-header">
              <div>
                <div class="section-title">Summary for doctors</div>
                <div class="section-subtitle">Weekly pain trend overview</div>
              </div>
            </div>
            <div id="summary-container"></div>
          </div>
        </div>

        <!-- Calendar Tab -->
        <div id="tab-calendar" class="tab-panel" style="display: none;">
          <div class="section-header">
            <div>
              <div class="section-title">Calendar View</div>
              <div class="section-subtitle">Tap a day to view or add</div>
            </div>
            <button class="btn-ghost no-print" id="btn-today">Today</button>
          </div>

          <div class="calendar-wrapper">
            <div class="calendar-header">
              <button class="btn-ghost no-print" id="btn-prev-month">‚Äπ</button>
              <div class="calendar-month" id="calendar-month-label"></div>
              <button class="btn-ghost no-print" id="btn-next-month">‚Ä∫</button>
            </div>

            <div class="calendar-grid" id="calendar-grid"></div>

            <div class="calendar-legend">
              <div class="legend-item">
                <span class="legend-color" style="background: var(--red);"></span> Bad
              </div>
              <div class="legend-item">
                <span class="legend-color" style="background: var(--yellow);"></span> Meh
              </div>
              <div class="legend-item">
                <span class="legend-color" style="background: var(--green);"></span> Good
              </div>
            </div>
          </div>

          <div>
            <div class="day-details-title" id="day-details-title">Today</div>
            <div id="day-details-container"></div>
          </div>
        </div>

        <!-- Ideas Tab -->
        <div id="tab-ideas" class="tab-panel" style="display: none;">
          <div class="section-header">
            <div>
              <div class="section-title">Ideas for Recovery</div>
              <div class="section-subtitle">Doctors, stretches, procedures‚Ä¶</div>
            </div>
          </div>

          <div class="ideas-wrapper">
            <div class="idea-form no-print">
              <div class="idea-form-row">
                <div class="label">Idea Title</div>
                <input id="idea-title-input" class="idea-input" />
              </div>
              <div class="idea-form-row">
                <div class="label">Details</div>
                <textarea id="idea-body-input" class="idea-textarea"></textarea>
              </div>
              <div class="idea-form-actions">
                <button id="btn-add-idea" class="btn-primary">Save Idea</button>
                <button id="btn-delete-idea" class="btn-small btn-small-danger" style="display:none;">üóë Delete</button>
              </div>
            </div>

            <div id="ideas-list"></div>
          </div>
        </div>

        <div class="bottom-safe no-print"></div>
      </div>

      <!-- Entry Sheet (Add/Edit Entry) -->
      <div id="entry-sheet-backdrop" class="entry-sheet-backdrop no-print">
        <div class="entry-sheet">
          <div class="entry-sheet-header">
            <button id="btn-cancel-entry" class="btn-ghost">Cancel</button>
            <div class="entry-sheet-title" id="entry-sheet-title">New Entry</div>
            <div class="entry-sheet-actions">
              <button id="btn-save-entry" class="btn-primary">Save</button>
            </div>
          </div>

          <div class="section-subtitle" style="margin-bottom: 6px;">
            Fill this out at the end of your day.
          </div>

          <div class="entry-form-row">
            <div class="label">Date</div>
            <input type="date" id="entry-date-input" class="entry-input" />
          </div>

          <div class="entry-form-row">
            <div class="label">Activity / Symptom</div>
            <textarea id="entry-activity-input" class="entry-textarea"></textarea>
          </div>

          <div class="entry-form-row">
            <div class="label">Treatment / Meds</div>
            <textarea id="entry-treatment-input" class="entry-textarea"></textarea>
          </div>

          <div class="entry-form-row">
            <div class="label">Feeling / Reflection</div>
            <textarea id="entry-feeling-input" class="entry-textarea"></textarea>
          </div>

          <div class="entry-form-row">
            <div class="label">Overall Pain</div>
            <div class="pain-options" id="pain-options">
              <div class="pain-option" data-pain="bad">Bad</div>
              <div class="pain-option" data-pain="meh">Meh</div>
              <div class="pain-option" data-pain="good">Good</div>
            </div>
          </div>

          <div class="entry-form-row no-print" id="entry-delete-row" style="display:none; margin-top:10px;">
            <button id="btn-delete-entry" class="btn-small btn-small-danger">üóë Delete entry</button>
          </div>
        </div>
      </div>
      <!-- end sheet -->
    </div>
  </div>

  <script>
    "use strict";

    const STORAGE_KEYS = {
      entries: "entries_v1",
      ideas: "ideas_v1",
    };

    const PAIN_SCORE = { good: 1, meh: 2, bad: 3 };

    let entries = [];
    let ideas = [];

    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let selectedDate = formatDateKey(new Date());
    let selectedPain = null;
    let editingEntryId = null;
    let editingIdeaId = null;
    let currentCode = null;

    function entriesKey() {
      return `backlog_${currentCode || "DEFAULT"}_${STORAGE_KEYS.entries}`;
    }

    function ideasKey() {
      return `backlog_${currentCode || "DEFAULT"}_${STORAGE_KEYS.ideas}`;
    }

    function formatDateKey(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, "0");
      const d = String(date.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }

    function parseDateFromKey(dateStr) {
      const [y, m, d] = dateStr.split("-").map(Number);
      return new Date(y, m - 1, d);
    }

    function formatDisplayDate(dateStr) {
      const d = parseDateFromKey(dateStr);
      const opts = { month: "short", day: "numeric", year: "numeric" };
      return d.toLocaleDateString(undefined, opts);
    }

    function formatDisplayDateShort(dateStr) {
      const d = parseDateFromKey(dateStr);
      const opts = { month: "short", day: "numeric" };
      return d.toLocaleDateString(undefined, opts);
    }

    function formatTimeDisplay(dateObj) {
      const hrs = String(dateObj.getHours()).padStart(2, "0");
      const mins = String(dateObj.getMinutes()).padStart(2, "0");
      return `${hrs}:${mins}`;
    }

    function loadData() {
      try {
        const rawEntries = localStorage.getItem(entriesKey());
        const rawIdeas = localStorage.getItem(ideasKey());
        entries = rawEntries ? JSON.parse(rawEntries) : [];
        ideas = rawIdeas ? JSON.parse(rawIdeas) : [];
      } catch {
        entries = [];
        ideas = [];
      }
    }

    function saveEntries() {
      localStorage.setItem(entriesKey(), JSON.stringify(entries));
    }

    function saveIdeas() {
      localStorage.setItem(ideasKey(), JSON.stringify(ideas));
    }

    function sortEntries() {
      entries.sort((a, b) => {
        if (a.date === b.date) {
          return b.createdAt - a.createdAt;
        }
        return a.date < b.date ? 1 : -1;
      });
    }

    function painToPillClass(pain) {
      if (pain === "bad") return "pill-bad";
      if (pain === "meh") return "pill-meh";
      if (pain === "good") return "pill-good";
      return "pill-muted";
    }

    function painToLabel(pain) {
      if (pain === "bad") return "Bad";
      if (pain === "meh") return "Meh";
      if (pain === "good") return "Good";
      return "N/A";
    }

    function getWorstPainForDate(dateKey) {
      const todays = entries.filter((e) => e.date === dateKey);
      if (todays.length === 0) return null;
      if (todays.some((e) => e.pain === "bad")) return "bad";
      if (todays.some((e) => e.pain === "meh")) return "meh";
      if (todays.some((e) => e.pain === "good")) return "good";
      return null;
    }

    function deleteEntry(entryId) {
      if (!confirm("Delete this entry? This cannot be undone.")) return;
      entries = entries.filter((e) => e.id !== entryId);
      saveEntries();
      sortEntries();
      renderEntries();
      renderCalendar();
      renderDayDetails();
      closeEntrySheet();
    }

    function renderEntries() {
      sortEntries();
      const list = document.getElementById("entries-list");
      list.innerHTML = "";

      if (entries.length === 0) {
        list.innerHTML =
          '<div class="empty-state">No entries yet. Tap ‚ÄúÔºã‚Äù to add your first note.</div>';
        renderSummary();
        return;
      }

      entries.forEach((entry) => {
        const card = document.createElement("div");
        card.className = "card";

        const createdDate = new Date(entry.createdAt);
        const header = document.createElement("div");
        header.className = "card-header";

        const left = document.createElement("div");
        const dateEl = document.createElement("div");
        dateEl.className = "card-date";
        dateEl.textContent = formatDisplayDate(entry.date);

        const timeEl = document.createElement("div");
        timeEl.className = "card-time";
        timeEl.textContent = `Logged at ${formatTimeDisplay(createdDate)}`;

        left.appendChild(dateEl);
        left.appendChild(timeEl);

        const painPill = document.createElement("div");
        painPill.className = `pill ${painToPillClass(entry.pain)}`;
        painPill.textContent = painToLabel(entry.pain);

        header.appendChild(left);
        header.appendChild(painPill);

        const activityRow = document.createElement("div");
        activityRow.className = "card-row";
        activityRow.innerHTML =
          "<span class='field-label'>Activity / Symptom</span>" +
          `<div class="field-text">${entry.activity || "<span style='color:#aaa'>‚Äî</span>"}</div>`;

        const treatmentRow = document.createElement("div");
        treatmentRow.className = "card-row";
        treatmentRow.innerHTML =
          "<span class='field-label'>Treatment / Meds</span>" +
          `<div class="field-text">${entry.treatment || "<span style='color:#aaa'>‚Äî</span>"}</div>`;

        const feelingRow = document.createElement("div");
        feelingRow.className = "card-row";
        feelingRow.innerHTML =
          "<span class='field-label'>Feeling / Reflection</span>" +
          `<div class="field-text">${entry.feeling || "<span style='color:#aaa'>‚Äî</span>"}</div>`;

        card.appendChild(header);
        card.appendChild(activityRow);
        card.appendChild(treatmentRow);
        card.appendChild(feelingRow);

        card.addEventListener("click", () => {
          startEditEntry(entry);
        });

        list.appendChild(card);
      });

      renderSummary();
    }

    function renderCalendar() {
      const monthLabel = document.getElementById("calendar-month-label");
      const grid = document.getElementById("calendar-grid");
      grid.innerHTML = "";

      const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
      const monthName = firstDayOfMonth.toLocaleDateString(undefined, {
        month: "long",
        year: "numeric",
      });
      monthLabel.textContent = monthName;

      const dayLabels = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
      dayLabels.forEach((d) => {
        const lbl = document.createElement("div");
        lbl.className = "calendar-day-label";
        lbl.textContent = d;
        grid.appendChild(lbl);
      });

      const startWeekday = firstDayOfMonth.getDay();
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

      for (let i = 0; i < startWeekday; i++) {
        const cell = document.createElement("div");
        cell.className = "calendar-cell empty";
        grid.appendChild(cell);
      }

      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(currentYear, currentMonth, day);
        const dateKey = formatDateKey(date);
        const cell = document.createElement("div");
        cell.className = "calendar-cell";

        if (dateKey === selectedDate) {
          cell.classList.add("selected");
        }

        const worstPain = getWorstPainForDate(dateKey);
        if (worstPain === "bad") {
          cell.classList.add("bad");
        } else if (worstPain === "meh") {
          cell.classList.add("meh");
        } else if (worstPain === "good") {
          cell.classList.add("good");
        }

        const num = document.createElement("div");
        num.className = "date-number";
        num.textContent = day;
        cell.appendChild(num);

        cell.addEventListener("click", () => {
          selectedDate = dateKey;
          renderCalendar();
          renderDayDetails();

          const todays = entries.filter((e) => e.date === dateKey);
          if (todays.length === 0) {
            openEntrySheetForNew(dateKey);
          }
        });

        grid.appendChild(cell);
      }
    }

    function renderDayDetails() {
      const container = document.getElementById("day-details-container");
      const title = document.getElementById("day-details-title");
      title.textContent = formatDisplayDate(selectedDate);

      const todays = entries.filter((e) => e.date === selectedDate);
      container.innerHTML = "";

      if (todays.length === 0) {
        container.innerHTML =
          '<div class="day-details-empty">No entry for this day yet. Tap the date again to add one.</div>';
        return;
      }

      todays
        .slice()
        .sort((a, b) => b.createdAt - a.createdAt)
        .forEach((entry) => {
          const card = document.createElement("div");
          card.className = "card";

          const header = document.createElement("div");
          header.className = "card-header";
          const painPill = document.createElement("div");
          painPill.className = `pill ${painToPillClass(entry.pain)}`;
          painPill.textContent = painToLabel(entry.pain);
          header.appendChild(painPill);

          const activityRow = document.createElement("div");
          activityRow.className = "card-row";
          activityRow.innerHTML =
            "<span class='field-label'>Activity / Symptom</span>" +
            `<div class="field-text">${entry.activity || "<span style='color:#aaa'>‚Äî</span>"}</div>`;

          const treatmentRow = document.createElement("div");
          treatmentRow.className = "card-row";
          treatmentRow.innerHTML =
            "<span class='field-label'>Treatment / Meds</span>" +
            `<div class="field-text">${entry.treatment || "<span style='color:#aaa'>‚Äî</span>"}</div>`;

          const feelingRow = document.createElement("div");
          feelingRow.className = "card-row";
          feelingRow.innerHTML =
            "<span class='field-label'>Feeling / Reflection</span>" +
            `<div class="field-text">${entry.feeling || "<span style='color:#aaa'>‚Äî</span>"}</div>`;

          card.appendChild(header);
          card.appendChild(activityRow);
          card.appendChild(treatmentRow);
          card.appendChild(feelingRow);

          card.addEventListener("click", () => {
            startEditEntry(entry);
          });

          container.appendChild(card);
        });
    }

    function renderIdeas() {
      const list = document.getElementById("ideas-list");
      list.innerHTML = "";

      if (ideas.length === 0) {
        list.innerHTML =
          '<div class="empty-state">No ideas yet. Use this space for doctors, stretches, procedures, or anything that might help your back.</div>';
        return;
      }

      const sorted = ideas.slice().sort((a, b) => b.createdAt - a.createdAt);

      sorted.forEach((idea) => {
        const card = document.createElement("div");
        card.className = "idea-card";

        const title = document.createElement("div");
        title.className = "idea-title";
        title.textContent = idea.title || "(Untitled idea)";

        const body = document.createElement("div");
        body.className = "idea-body";
        body.textContent = idea.body || "‚Äî";

        const meta = document.createElement("div");
        meta.className = "idea-meta";

        const created = new Date(idea.createdAt);
        meta.textContent = `Saved on ${created.toLocaleString()}`;

        card.appendChild(title);
        card.appendChild(body);
        card.appendChild(meta);

        card.addEventListener("click", () => {
          startEditIdea(idea);
        });

        list.appendChild(card);
      });
    }

    // Weekly summary helpers
    function getWeekStartKey(dateKey) {
      const d = parseDateFromKey(dateKey);
      const day = d.getDay(); // 0 Sun - 6 Sat
      const diff = (day + 6) % 7; // Monday as start
      d.setDate(d.getDate() - diff);
      return formatDateKey(d);
    }

    function describeAverageScore(avg) {
      if (avg < 1.5) return "Mostly good days";
      if (avg < 2.25) return "Mixed pain days";
      return "Mostly difficult days";
    }

    function renderSummary() {
      const container = document.getElementById("summary-container");
      container.innerHTML = "";

      if (entries.length === 0) {
        container.innerHTML =
          '<div class="empty-state">Once you add entries, you‚Äôll see weekly pain patterns here for your doctor.</div>';
        return;
      }

      const weeks = {};
      entries.forEach((e) => {
        const wk = getWeekStartKey(e.date);
        if (!weeks[wk]) {
          weeks[wk] = {
            bad: 0,
            meh: 0,
            good: 0,
            total: 0,
            scoreSum: 0,
          };
        }
        if (e.pain === "bad") weeks[wk].bad++;
        if (e.pain === "meh") weeks[wk].meh++;
        if (e.pain === "good") weeks[wk].good++;
        weeks[wk].total++;
        weeks[wk].scoreSum += PAIN_SCORE[e.pain] || 0;
      });

      const weekKeys = Object.keys(weeks).sort((a, b) => (a < b ? 1 : -1)); // newest first

      weekKeys.forEach((wkKey) => {
        const data = weeks[wkKey];
        const avg = data.scoreSum / Math.max(data.total, 1);
        const desc = describeAverageScore(avg);

        const weekStart = wkKey;
        const weekStartDate = parseDateFromKey(weekStart);
        const weekEndDate = new Date(weekStartDate);
        weekEndDate.setDate(weekEndDate.getDate() + 6);
        const rangeLabel =
          formatDisplayDateShort(weekStart) +
          " ‚Äì " +
          formatDisplayDateShort(formatDateKey(weekEndDate));

        const card = document.createElement("div");
        card.className = "summary-card";

        const titleLine = document.createElement("div");
        titleLine.className = "summary-title-line";
        const left = document.createElement("div");
        left.textContent = `Week of ${formatDisplayDateShort(weekStart)}`;
        const right = document.createElement("div");
        right.textContent = desc;
        titleLine.appendChild(left);
        titleLine.appendChild(right);

        const sub = document.createElement("div");
        sub.className = "summary-sub";
        sub.textContent = rangeLabel;

        const countsRow = document.createElement("div");
        countsRow.className = "summary-row";
        countsRow.textContent =
          `Bad: ${data.bad} | Meh: ${data.meh} | Good: ${data.good} ` +
          `(entries: ${data.total})`;

        const avgRow = document.createElement("div");
        avgRow.className = "summary-row";
        avgRow.textContent = `Average pain score (1=good, 3=bad): ${avg.toFixed(
          2
        )}`;

        card.appendChild(titleLine);
        card.appendChild(sub);
        card.appendChild(countsRow);
        card.appendChild(avgRow);

        container.appendChild(card);
      });
    }

    function showTab(tabName) {
      const tabs = document.querySelectorAll(".tab");
      const panels = document.querySelectorAll(".tab-panel");

      tabs.forEach((t) =>
        t.classList.toggle("active", t.dataset.tab === tabName)
      );
      panels.forEach((p) => {
        p.style.display =
          p.id === `tab-${tabName}` ? "block" : "none";
      });

      if (tabName === "calendar") {
        renderCalendar();
        renderDayDetails();
      }
    }

    function openEntrySheetForNew(dateOverride) {
      editingEntryId = null;
      const backdrop = document.getElementById("entry-sheet-backdrop");
      const title = document.getElementById("entry-sheet-title");
      title.textContent = "New Entry";

      backdrop.classList.add("active");

      const dateInput = document.getElementById("entry-date-input");
      dateInput.value = dateOverride || selectedDate || formatDateKey(new Date());

      document.getElementById("entry-activity-input").value = "";
      document.getElementById("entry-treatment-input").value = "";
      document.getElementById("entry-feeling-input").value = "";

      setPainSelection(null);

      document.getElementById("entry-delete-row").style.display = "none";
    }

    function startEditEntry(entry) {
      editingEntryId = entry.id;
      const backdrop = document.getElementById("entry-sheet-backdrop");
      const title = document.getElementById("entry-sheet-title");
      title.textContent = "Edit Entry";

      backdrop.classList.add("active");

      document.getElementById("entry-date-input").value = entry.date;
      document.getElementById("entry-activity-input").value = entry.activity || "";
      document.getElementById("entry-treatment-input").value = entry.treatment || "";
      document.getElementById("entry-feeling-input").value = entry.feeling || "";

      setPainSelection(entry.pain || null);

      document.getElementById("entry-delete-row").style.display = "block";
    }

    function closeEntrySheet() {
      const backdrop = document.getElementById("entry-sheet-backdrop");
      backdrop.classList.remove("active");
      editingEntryId = null;
      setPainSelection(null);
      document.getElementById("entry-delete-row").style.display = "none";
    }

    function setPainSelection(pain) {
      selectedPain = pain;
      const options = document.querySelectorAll(".pain-option");
      options.forEach((opt) => {
        opt.classList.toggle("active", opt.dataset.pain === pain);
      });
    }

    function handleSaveEntry() {
      const date =
        document.getElementById("entry-date-input").value ||
        formatDateKey(new Date());
      const activity = document
        .getElementById("entry-activity-input")
        .value.trim();
      const treatment = document
        .getElementById("entry-treatment-input")
        .value.trim();
      const feeling = document
        .getElementById("entry-feeling-input")
        .value.trim();

      const pain = selectedPain || "meh";

      if (!currentCode) {
        alert("Please enter an access code first.");
        return;
      }

      if (editingEntryId) {
        const idx = entries.findIndex((e) => e.id === editingEntryId);
        if (idx !== -1) {
          entries[idx].date = date;
          entries[idx].activity = activity;
          entries[idx].treatment = treatment;
          entries[idx].feeling = feeling;
          entries[idx].pain = pain;
        }
      } else {
        const newEntry = {
          id: Date.now().toString(),
          date,
          activity,
          treatment,
          feeling,
          pain,
          createdAt: Date.now(),
        };
        entries.push(newEntry);
      }

      saveEntries();
      sortEntries();
      renderEntries();

      selectedDate = date;
      renderCalendar();
      renderDayDetails();

      closeEntrySheet();
    }

    // Ideas editing
    function resetIdeaForm() {
      const titleInput = document.getElementById("idea-title-input");
      const bodyInput = document.getElementById("idea-body-input");
      const saveBtn = document.getElementById("btn-add-idea");
      const delBtn = document.getElementById("btn-delete-idea");

      titleInput.value = "";
      bodyInput.value = "";
      editingIdeaId = null;
      saveBtn.textContent = "Save Idea";
      delBtn.style.display = "none";
    }

    function startEditIdea(idea) {
      const titleInput = document.getElementById("idea-title-input");
      const bodyInput = document.getElementById("idea-body-input");
      const saveBtn = document.getElementById("btn-add-idea");
      const delBtn = document.getElementById("btn-delete-idea");

      editingIdeaId = idea.id;
      titleInput.value = idea.title || "";
      bodyInput.value = idea.body || "";
      saveBtn.textContent = "Update Idea";
      delBtn.style.display = "inline-flex";

      const content = document.querySelector(".content");
      if (content) {
        content.scrollTo({ top: 0, behavior: "smooth" });
      }
    }

    function deleteIdea(id) {
      if (!confirm("Delete this idea?")) return;
      ideas = ideas.filter((i) => i.id !== id);
      saveIdeas();
      renderIdeas();
      resetIdeaForm();
    }

    function handleSaveIdea() {
      const titleInput = document.getElementById("idea-title-input");
      const bodyInput = document.getElementById("idea-body-input");

      const title = titleInput.value.trim();
      const body = bodyInput.value.trim();

      if (!currentCode) {
        alert("Please enter an access code first.");
        return;
      }

      if (!title && !body) {
        titleInput.focus();
        return;
      }

      if (editingIdeaId) {
        const idx = ideas.findIndex((i) => i.id === editingIdeaId);
        if (idx !== -1) {
          ideas[idx].title = title;
          ideas[idx].body = body;
        }
      } else {
        const newIdea = {
          id: Date.now().toString(),
          title,
          body,
          createdAt: Date.now(),
        };
        ideas.push(newIdea);
      }

      saveIdeas();
      renderIdeas();
      resetIdeaForm();
    }

    function exportDataAsText() {
      sortEntries();

      const now = new Date();
      const lines = [];

      lines.push("BackLog export");
      lines.push(`Access code: ${currentCode || "(none)"}`);
      lines.push(`Generated at: ${now.toLocaleString()}`);
      lines.push("");
      lines.push("=== Entries ===");
      lines.push("");

      if (entries.length === 0) {
        lines.push("(No entries recorded)");
      } else {
        entries.forEach((e, index) => {
          const created = new Date(e.createdAt);
          lines.push(`Entry #${index + 1}`);
          lines.push(`  Date: ${e.date} (${formatDisplayDate(e.date)})`);
          lines.push(`  Logged at: ${formatTimeDisplay(created)}`);
          lines.push(`  Overall pain: ${painToLabel(e.pain)}`);
          lines.push(`  Activity / Symptom:`);
          lines.push(`    ${e.activity || "-"}`);
          lines.push(`  Treatment / Meds:`);
          lines.push(`    ${e.treatment || "-"}`);
          lines.push(`  Feeling / Reflection:`);
          lines.push(`    ${e.feeling || "-"}`);
          lines.push("");
        });
      }

      lines.push("");
      lines.push("=== Ideas ===");
      lines.push("");

      if (ideas.length === 0) {
        lines.push("(No ideas saved)");
      } else {
        ideas
          .slice()
          .sort((a, b) => b.createdAt - a.createdAt)
          .forEach((idea, idx) => {
            const created = new Date(idea.createdAt);
            lines.push(`Idea #${idx + 1}`);
            lines.push(`  Title: ${idea.title || "(Untitled idea)"}`);
            lines.push(`  Saved at: ${created.toLocaleString()}`);
            lines.push(`  Details:`);
            (idea.body || "-")
              .split("\n")
              .forEach((line) => lines.push(`    ${line}`));
            lines.push("");
          });
      }

      const blob = new Blob([lines.join("\n")], {
        type: "text/plain;charset=utf-8",
      });

      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `backlog_export_${formatDateKey(now)}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function initAppForCode(code) {
      currentCode = code;
      const codeTag = document.getElementById("code-tag");
      codeTag.style.display = "inline-block";
      codeTag.textContent = `Code: ${code}`;

      entries = [];
      ideas = [];
      loadData();
      sortEntries();
      renderEntries();
      renderIdeas();

      const now = new Date();
      currentMonth = now.getMonth();
      currentYear = now.getFullYear();
      selectedDate = formatDateKey(now);
      renderCalendar();
      renderDayDetails();

      closeEntrySheet();
      resetIdeaForm();
    }

    function handleEnterCode() {
      const input = document.getElementById("code-input");
      const errorEl = document.getElementById("code-error");
      let raw = (input.value || "").trim();
      raw = raw.replace(/\s+/g, "");
      const normalized = raw.toUpperCase();
      const valid = /^[0-9]{4}[A-Z]{3}$/.test(normalized);

      if (!valid) {
        errorEl.textContent = "Please enter 4 digits + 3 letters (e.g. 1234ABC).";
        return;
      }

      errorEl.textContent = "";
      input.value = normalized;

      const overlay = document.getElementById("intro-overlay");
      overlay.style.display = "none";

      initAppForCode(normalized);
    }

    document.addEventListener("DOMContentLoaded", () => {
      const tabButtons = document.querySelectorAll(".tab");
      tabButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          showTab(btn.dataset.tab);
        });
      });

      document
        .getElementById("btn-add-entry")
        .addEventListener("click", () => openEntrySheetForNew());

      document
        .getElementById("btn-cancel-entry")
        .addEventListener("click", closeEntrySheet);

      document
        .getElementById("btn-save-entry")
        .addEventListener("click", handleSaveEntry);

      document
        .getElementById("entry-sheet-backdrop")
        .addEventListener("click", (e) => {
          if (e.target.id === "entry-sheet-backdrop") {
            closeEntrySheet();
          }
        });

      document
        .getElementById("btn-delete-entry")
        .addEventListener("click", () => {
          if (editingEntryId) deleteEntry(editingEntryId);
        });

      document
        .getElementById("btn-add-idea")
        .addEventListener("click", handleSaveIdea);

      document
        .getElementById("btn-delete-idea")
        .addEventListener("click", () => {
          if (editingIdeaId) deleteIdea(editingIdeaId);
        });

      document
        .getElementById("btn-export")
        .addEventListener("click", exportDataAsText);

      document
        .getElementById("btn-print")
        .addEventListener("click", () => window.print());

      const painOpts = document.querySelectorAll(".pain-option");
      painOpts.forEach((opt) => {
        opt.addEventListener("click", () => {
          setPainSelection(opt.dataset.pain);
        });
      });

      document
        .getElementById("btn-prev-month")
        .addEventListener("click", () => {
          currentMonth--;
          if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
          }
          renderCalendar();
          renderDayDetails();
        });

      document
        .getElementById("btn-next-month")
        .addEventListener("click", () => {
          currentMonth++;
          if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
          }
          renderCalendar();
          renderDayDetails();
        });

      document.getElementById("btn-today").addEventListener("click", () => {
        const today = new Date();
        currentMonth = today.getMonth();
        currentYear = today.getFullYear();
        selectedDate = formatDateKey(today);
        renderCalendar();
        renderDayDetails();
      });

      document
        .getElementById("btn-enter-app")
        .addEventListener("click", handleEnterCode);

      document
        .getElementById("code-input")
        .addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            handleEnterCode();
          }
        });

      document
        .getElementById("code-tag")
        .addEventListener("click", () => {
          const overlay = document.getElementById("intro-overlay");
          const input = document.getElementById("code-input");
          const errorEl = document.getElementById("code-error");

          overlay.style.display = "flex";
          input.value = currentCode || "";
          errorEl.textContent = "";
        });

      // we intentionally do NOT auto-init a code,
      // user must enter one on intro screen.
    });
  </script>
</body>
</html>
